<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>互动剧情页面 (V16 - 居中优化版)</title>
    <style>
        /* --- 基础与游戏区样式 --- */
        html, body { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .game-wrapper { width: 100%; max-width: 600px; height: 95vh; max-height: 960px; overflow: hidden; border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); position: relative; background-color: #ffffff; display: flex; flex-direction: column; transition: filter 0.3s ease; }
        .game-wrapper.inert { pointer-events: none; filter: blur(4px); }
        .navigation-header { display: flex; flex-shrink: 0; border-bottom: 1px solid #e9ecef; }
        .nav-button { flex: 1; padding: 15px 10px; background-color: #f8f9fa; border: none; outline: none; cursor: pointer; font-size: 1em; color: #495057; transition: background-color 0.2s ease, color 0.2s ease; border-bottom: 3px solid transparent; }
        .nav-button.active { color: #007bff; border-bottom-color: #007bff; background-color: #fff; }
        .page-slider { display: flex; width: 300%; height: 100%; transition: transform 0.3s ease; }
        .page-container { flex-grow: 1; overflow: hidden; }
        .page { width: 33.3333%; flex-shrink: 0; height: 100%; box-sizing: border-box; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; }
        .character-image-placeholder { width: 100%; aspect-ratio: 4 / 3; background-color: #e9ecef; border-radius: 12px; display: flex; justify-content: center; align-items: center; color: #adb5bd; font-size: 1.2em; background-image: url('https://via.placeholder.com/600x450/cccccc/888888?text=角色图片'); background-size: cover; background-position: center; position: relative; }
        #character-name-input { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 36%; max-width: 300px; padding: 8px 12px; border: none; border-radius: 16px; background-color: rgba(255, 255, 255, 0.4); backdrop-filter: blur(4px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); text-align: center; font-size: 0.9em; font-weight: 500; color: #333; outline: none; transition: box-shadow 0.2s ease; }
        #character-name-input:focus { box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.4); }
        .narrator-box { background-color: #e9ecef; border-left: 5px solid #495057; border-radius: 8px; padding: 0; }
        #narrator-text { width: 100%; padding: 20px; box-sizing: border-box; border: none; background-color: transparent; resize: none; outline: none; font-family: inherit; font-size: 1.1em; line-height: 1.6; color: #343a40; overflow-y: hidden; }
        
        /* MODIFICATION START: CSS for loading overlay updated */
        .page-center { /* position: relative; (不再需要) */ } 
        .loading-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(255, 255, 255, 0.8); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.2em; 
            color: #333; 
            z-index: 999; 
            visibility: hidden; 
            opacity: 0; 
            transition: visibility 0s 0.2s, opacity 0.2s ease; 
            border-radius: 16px; /* 匹配父容器圆角 */
        } 
        /* MODIFICATION END */

        .loading-overlay.visible { visibility: visible; opacity: 1; transition-delay: 0s; } .character-info-box { background-color: #f8f9fa; border-radius: 8px; color: #495057; flex-grow: 1; padding: 0; display: flex; } #character-info-textarea { flex-grow: 1; padding: 20px; box-sizing: border-box; border: none; background-color: transparent; resize: none; outline: none; font-family: inherit; font-size: 1em; line-height: 1.6; color: #495057; overflow-y: hidden; } .player-options { display: flex; flex-direction: column; gap: 12px; } .option-bubble { width: 100%; box-sizing: border-box; background-color: #007bff; color: white; border: none; border-radius: 25px; padding: 12px 20px; font-size: 1em; cursor: pointer; text-align: center; transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2); } #free-text-input { width: 100%; padding: 12px 15px; border: 2px solid #ced4da; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .menu-container { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .menu-item { background-color: #6c757d; color: white; padding: 15px 25px; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; text-align: left; }
        
        /* --- 统一模态框样式 --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; visibility: hidden; opacity: 0; transition: visibility 0s 0.2s, opacity 0.2s ease; z-index: 1000; }
        .modal-overlay.visible { visibility: visible; opacity: 1; transition: visibility 0s, opacity 0.2s ease; }
        .modal-window { background-color: #fff; border-radius: 12px; width: 90%; max-width: 550px; display: flex; flex-direction: column; box-sizing: border-box; overflow: hidden; max-height: 85vh; }
        .modal-nav { display: flex; flex-shrink: 0; border-bottom: 1px solid #e0e0e0; }
        .modal-nav.hidden { display: none; }
        .modal-nav-btn { flex: 1; padding: 14px 10px; border: none; background-color: #f8f9fa; cursor: pointer; font-size: 1em; color: #495057; transition: all 0.2s ease; border-bottom: 3px solid transparent; }
        .modal-nav-btn.active { color: #007bff; border-bottom-color: #007bff; background-color: #fff; }
        .modal-page-container { padding: 25px 25px 15px; overflow-y: auto; }
        .modal-page { display: none; flex-direction: column; gap: 20px; }
        .modal-page.active { display: flex; }
        .modal-footer { padding: 0 25px 25px; }
        .modal-close-btn { background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; width: 100%; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: 600; color: #495057; font-size: 0.9em; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; box-sizing: border-box; font-family: inherit; }
        #note-page h3 { margin: 0 0 10px; text-align: center; }
        .modal-window textarea { min-height: 15vh; resize: none; overflow-y: hidden; }
        #random-prompt { min-height: 5em; }
        .start-game-btn { background-color: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; margin-top: 20px; width: 100%; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="game-wrapper" id="game-wrapper">
        <div class="navigation-header"><button class="nav-button" data-page-index="0">NPC</button><button class="nav-button active" data-page-index="1">剧情</button><button class="nav-button" data-page-index="2">菜单</button></div>
        <div class="page-container">
            <div class="page-slider" id="page-slider">
                <div class="page page-left"><div class="character-image-placeholder" draggable="false"><input type="text" id="character-name-input" placeholder="NPC档案" draggable="false"></div><div class="character-info-box"><textarea id="character-info-textarea" placeholder="关于NPC的设定..."></textarea></div></div>
                <!-- MODIFICATION: loading-overlay 元素已从下方移出 -->
                <div class="page page-center"><div class="narrator-box"><textarea id="narrator-text">请先完成初始设定...</textarea></div><div class="player-options"><button class="option-bubble">...</button><button class="option-bubble">...</button><button class="option-bubble">...</button></div><div class="player-input-area"><input type="text" id="free-text-input" placeholder="或者，输入你的其他想法（按回车确认）..."></div></div>
                <div class="page page-right"><div class="menu-container"><div class="menu-item" data-modal-key="故事背景">故事背景</div><div class="menu-item" data-modal-key="我的人设">我的人设</div><div class="menu-item" data-modal-key="任务要求">任务要求</div><div class="menu-item" data-modal-key="状态栏">状态栏</div><div class="menu-item" id="settings-btn">设置</div></div></div>
            </div>
        </div>

        <!-- MODIFICATION: loading-overlay 元素移至此处，作为 game-wrapper 的直接子元素 -->
        <div class="loading-overlay" id="loading-overlay"><p>AI 正在构思剧情...</p></div>
    </div>

    <!-- 统一模态框 -->
    <div class="modal-overlay" id="main-modal">
        <div class="modal-window">
            <div class="modal-nav" id="modal-nav">
                <button class="modal-nav-btn" data-tab="note">笔记</button>
                <button class="modal-nav-btn" data-tab="custom">自定义</button>
                <button class="modal-nav-btn" data-tab="random">随机生成</button>
                <button class="modal-nav-btn" data-tab="api">API 设置</button>
            </div>
            <div class="modal-page-container">
                <div class="modal-page" id="note-page"><h3 id="note-title"></h3><div class="form-group"><textarea id="note-textarea"></textarea></div></div>
                <div class="modal-page" id="custom-page"><div class="form-group"><label for="user-name">我的名字</label><input type="text" id="user-name"></div><div class="form-group"><label for="story-background">故事背景</label><textarea id="story-background"></textarea></div><button class="start-game-btn" id="custom-generate-btn">生成开场白并开始</button></div>
                <div class="modal-page" id="random-page"><div class="form-group"><label for="random-prompt">提示词 (Prompt)</label><textarea id="random-prompt" placeholder="例如：深海、古神、遗迹"></textarea></div><button class="start-game-btn" id="random-generate-btn">一键生成世界观并开始</button></div>
                <div class="modal-page" id="api-page"><div class="form-group"><label for="api-url">URL</label><input type="text" id="api-url" placeholder="例如"></div><div class="form-group"><label for="api-key">密钥 (Key)</label><input type="password" id="api-key"></div><div class="form-group"><label for="api-model">模型 (Model)</label><input type="text" id="api-model" placeholder="例如: gpt-4o-mini"></div></div>
            </div>
            <div class="modal-footer"><button class="modal-close-btn" id="modal-close-btn">保存并关闭</button></div>
        </div>
    </div>

    <script>
        // --- 元素获取 (无改动) ---
        const wrapper = document.getElementById('game-wrapper'); const loadingOverlay = document.getElementById('loading-overlay'); const narratorTextElement = document.getElementById('narrator-text'); const optionButtons = document.querySelectorAll('.player-options .option-bubble'); const freeTextInput = document.getElementById('free-text-input'); const pageSlider = document.getElementById('page-slider'); const navButtons = document.querySelectorAll('.nav-button'); const characterNameInput = document.getElementById('character-name-input'); const characterInfoTextarea = document.getElementById('character-info-textarea');
        const mainModal = document.getElementById('main-modal'); const modalNav = document.getElementById('modal-nav'); const modalNavBtns = mainModal.querySelectorAll('.modal-nav-btn'); const modalPages = mainModal.querySelectorAll('.modal-page'); const noteTitle = document.getElementById('note-title'); const noteTextarea = document.getElementById('note-textarea'); const closeBtn = document.getElementById('modal-close-btn');

        // --- 数据存储 (无改动) ---
        let gameHistory = []; let isAwaitingAI = false;
        const apiSettingsData = { url: "", key: "111", model: "gemini-2.5-pro-preview-06-05" };
        const noteData = { "故事背景": "", "我的人设": "", "任务要求": "找回记忆，探索世界。", "状态栏": "健康: 良好, 装备: 普通衣物" };
        let currentNoteKey = null; let gameStarted = false;

        // --- API 调用核心 (无改动) ---
        async function callGenerativeAPI(prompt) { 
            if (!apiSettingsData.key || !apiSettingsData.url) { alert("请先在“设置”中完整填写您的API URL和密钥！"); return null; }
            try {
                const response = await fetch(apiSettingsData.url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiSettingsData.key}` },
                    body: JSON.stringify({ model: apiSettingsData.model, messages: [{ role: 'user', content: prompt }], response_format: { type: "json_object" } })
                });
                if (!response.ok) { const errorBody = await response.json().catch(() => ({})); const errorMessage = errorBody.error ? errorBody.error.message : `HTTP status ${response.status}`; throw new Error(`API 请求失败: ${errorMessage}`); }
                const result = await response.json();
                return JSON.parse(result.choices[0].message.content);
            } catch (error) {
                console.error("API 调用或解析出错:", error); alert(`API 调用出错: ${error.message}\n请检查API设置、网络连接或查看控制台获取更多信息。`);
                loadingOverlay.classList.remove('visible'); isAwaitingAI = false; return null;
            }
        }
        
        // --- 文本框自动增高函数 (无改动) ---
        function autoGrowTextarea(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        // --- 游戏主逻辑 (无改动) ---
        function updateUI(data) {
            if (!data) return;
            if (data.narratorText && data.options && Array.isArray(data.options)) {
                narratorTextElement.value = data.narratorText;
                autoGrowTextarea(narratorTextElement);
                for (let i = 0; i < optionButtons.length; i++) {
                    optionButtons[i].textContent = data.options[i] || `...`;
                }
            }
            if (data.characterUpdate) {
                noteData["状态栏"] += `, ${data.characterUpdate}`;
            }
            if (data.npcUpdates && Array.isArray(data.npcUpdates)) {
                let currentText = characterInfoTextarea.value;
                data.npcUpdates.forEach(update => {
                    if (!update.name || !update.info) return;
                    const npcName = update.name.trim();
                    const newInfo = update.info.trim();
                    const regex = new RegExp(`<${npcName}>([\\s\\S]*?)<\\/${npcName}>`, 'g');
                    const match = regex.exec(currentText);
                    if (match) {
                        const existingInfo = match[1];
                        const updatedBlock = `<${npcName}>${existingInfo}\n- ${newInfo}</${npcName}>`;
                        currentText = currentText.replace(match[0], updatedBlock);
                    } else {
                        const newBlock = `<${npcName}>${npcName}的信息:\n- ${newInfo}</${npcName}>`;
                        currentText += (currentText.length > 0 ? '\n\n' : '') + newBlock;
                    }
                });
                characterInfoTextarea.value = currentText;
                autoGrowTextarea(characterInfoTextarea);
            }
        }
        async function processPlayerChoice(choiceText) {
            if (isAwaitingAI) return;
            isAwaitingAI = true; loadingOverlay.classList.add('visible');
            gameHistory.push({ narrator: narratorTextElement.value.trim(), choice: choiceText });
            if (gameHistory.length > 5) gameHistory.shift();
            const historyText = gameHistory.map(h => `旁白: ${h.narrator}\n你的选择: ${h.choice}`).join('\n\n');
            const prompt = `你是一位顶级的文字游戏引擎。根据已知信息，生成后续剧情。严格遵循以下 JSON 格式输出:
{
  "narratorText": "（新生成的旁白）",
  "options": [
    "（选项一，生成推动剧情向最合理的情况发展的选项）", 
    "（选项二，生成剧情转折的选项）", 
    "（选项三，生成快速推进或时间转换的选项）"
  ],
  "characterUpdate": "（对“状态栏”的简短更新，如“获得道具”，若无则留空字符串）",
  "npcUpdates": [
    {
      "name": "（剧情中信息有更新的NPC的名字）", 
      "info": "（关于该NPC的新增或变化的信息，只写核心内容）"
    }
  ]
}
---
已知信息:
故事背景: ${noteData["故事背景"]}
我的人设: ${noteData["我的人设"]}
任务要求: ${noteData["任务要求"]}
状态栏: ${noteData["状态栏"]}
当前所有NPC信息: ${characterInfoTextarea.value.trim()}
---
当前场景与历史:
当前旁白: ${narratorTextElement.value.trim()}
我的选择: ${choiceText}
历史记录:
${historyText}`;
            const aiResponse = await callGenerativeAPI(prompt);
            if (aiResponse) updateUI(aiResponse);
            loadingOverlay.classList.remove('visible'); isAwaitingAI = false;
        }

        // --- 统一模态框逻辑 (无改动) ---
        function switchModalTab(targetTab) {
            modalNavBtns.forEach(btn => btn.classList.remove('active'));
            modalPages.forEach(page => page.classList.remove('active'));
            mainModal.querySelector(`.modal-nav-btn[data-tab="${targetTab}"]`).classList.add('active');
            mainModal.querySelector(`#${targetTab}-page`).classList.add('active');
        }
        function openModal(config) {
            document.getElementById('api-url').value = apiSettingsData.url;
            document.getElementById('api-key').value = apiSettingsData.key;
            document.getElementById('api-model').value = apiSettingsData.model;
            const storyBgTextarea = document.getElementById('story-background');
            const randomPromptTextarea = document.getElementById('random-prompt');
            storyBgTextarea.value = noteData['故事背景'];
            autoGrowTextarea(storyBgTextarea);
            autoGrowTextarea(randomPromptTextarea); 
            if (config.mode === 'note') {
                modalNav.classList.add('hidden');
                currentNoteKey = config.key;
                noteTitle.textContent = config.key;
                noteTextarea.value = noteData[config.key];
                autoGrowTextarea(noteTextarea);
                switchModalTab('note');
            } else { // 'settings'
                modalNav.classList.remove('hidden');
                mainModal.querySelector('.modal-nav-btn[data-tab="note"]').classList.add('hidden');
                switchModalTab(config.initialTab);
            }
            mainModal.classList.add('visible');
            wrapper.classList.add('inert');
        }
        function closeModal() {
            apiSettingsData.url = document.getElementById('api-url').value.trim();
            apiSettingsData.key = document.getElementById('api-key').value.trim();
            apiSettingsData.model = document.getElementById('api-model').value.trim() || 'gemini-2.5-pro-preview-06-05';
            noteData['故事背景'] = document.getElementById('story-background').value.trim();
            if (currentNoteKey) {
                noteData[currentNoteKey] = noteTextarea.value.trim();
            }
            mainModal.classList.remove('visible');
            wrapper.classList.remove('inert');
            currentNoteKey = null;
        }
        async function handleGameStart(startFunction) {
            gameHistory = [];
            noteData["状态栏"] = "";
            characterNameInput.value = '';
            characterInfoTextarea.value = '';
            isAwaitingAI = true;
            loadingOverlay.classList.add('visible');
            closeModal();
            await startFunction();
            gameStarted = true;
            loadingOverlay.classList.remove('visible');
            isAwaitingAI = false;
        }

        // --- 事件监听器 (无改动) ---
        document.querySelectorAll('[data-modal-key]').forEach(item => item.addEventListener('click', () => openModal({ mode: 'note', key: item.getAttribute('data-modal-key') })));
        document.getElementById('settings-btn').addEventListener('click', () => openModal({ mode: 'settings', initialTab: 'api' }));
        closeBtn.addEventListener('click', closeModal);
        mainModal.addEventListener('click', (event) => { if (event.target === mainModal) closeModal(); });
        modalNavBtns.forEach(button => button.addEventListener('click', () => { if(button.dataset.tab !== 'note') switchModalTab(button.dataset.tab); }));
        [noteTextarea, narratorTextElement, characterInfoTextarea, document.getElementById('story-background'), document.getElementById('random-prompt')].forEach(textarea => { 
            textarea.addEventListener('input', () => autoGrowTextarea(textarea)); 
        });
        document.getElementById('custom-generate-btn').addEventListener('click', () => { handleGameStart(async () => { 
            const userName = document.getElementById('user-name').value.trim(); 
            const storyBg = document.getElementById('story-background').value.trim(); 
            if (!userName || !storyBg) { 
                alert('请填写你的名字和故事背景！'); 
                return; 
            } 
            noteData["我的人设"] = `姓名: ${userName}`;
            const prompt = `作为游戏开篇生成器，你根据玩家的名字和故事背景，生成引人入胜的开场白和三个初始选项。你是模拟器之中的命运主宰。你会让所有该相遇的人相遇，该发生的故事必然发生——命运是合理，是巧合，是不可避免，是你的模拟！故事不能停滞不前，你必须主动推进每一章剧情，让冲突、成长、相遇、误会、和解不断上演。你会洞察场内“命运”，也会揭示场外“线索”；主动埋下伏笔并负责后续回收，实现故事的完整闭环。你必须大胆揭示角色鲜为人知的真实，让关键人物不再被动等待，而是主动推动命运变化。严格遵循以下 JSON 格式输出: {"narratorText": "...", "options": ["...", "...", "..."] } --- 初始信息 --- 玩家名字: ${userName} 故事背景: ${storyBg}`; 
            const aiResponse = await callGenerativeAPI(prompt); 
            if (aiResponse) updateUI(aiResponse); 
        }); });
        document.getElementById('random-generate-btn').addEventListener('click', () => { handleGameStart(async () => { const promptWord = document.getElementById('random-prompt').value.trim(); if (!promptWord) { alert('请输入提示词！'); return; } const prompt = `作为游戏世界构建师，根据提示词，创造一个完整的开局设定。严格 JSON 输出: { "storyBackground": "...", "userPersona": "...", "charName": "...", "charDetails": "...", "narratorText": "...", "options": ["...", "...", "..."] } 提示词: ${promptWord}`; const aiResponse = await callGenerativeAPI(prompt); if (aiResponse) { noteData["故事背景"] = aiResponse.storyBackground || ''; noteData["我的人设"] = aiResponse.userPersona || ''; characterNameInput.value = aiResponse.charName || ''; characterInfoTextarea.value = aiResponse.charDetails || ''; updateUI(aiResponse); } }); });
        optionButtons.forEach(button => button.addEventListener('click', () => { if(button.textContent !== '...' && gameStarted) processPlayerChoice(button.textContent)}));
        freeTextInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') { event.preventDefault(); const choice = freeTextInput.value.trim(); if (choice && gameStarted) { processPlayerChoice(choice); freeTextInput.value = ''; } } });
        
        // --- 页面切换与自适应 (无改动) ---
        let currentPageIndex = 1;
        function sliderGoToPage(pageIndex) {
             const containerWidth = wrapper.querySelector('.page-container').clientWidth; pageSlider.style.transform = `translateX(${pageIndex * -containerWidth}px)`; navButtons.forEach(btn => btn.classList.remove('active')); document.querySelector(`.nav-button[data-page-index="${pageIndex}"]`).classList.add('active'); currentPageIndex = pageIndex; 
        }
        navButtons.forEach(button => button.addEventListener('click', () => sliderGoToPage(parseInt(button.dataset.pageIndex))));
        window.addEventListener('resize', () => sliderGoToPage(currentPageIndex));
        
        // --- 初始化 (无改动) ---
        document.addEventListener('DOMContentLoaded', () => {
            sliderGoToPage(1);
            autoGrowTextarea(narratorTextElement);
            autoGrowTextarea(characterInfoTextarea);
            openModal({ mode: 'settings', initialTab: 'custom' });
        });
    </script>
</body>
</html>
